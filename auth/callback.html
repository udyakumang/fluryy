<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fluryy — Signing you in…</title>
  <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
  <link rel="alternate icon" href="/assets/favicon.png" sizes="32x32">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;padding:2rem}
    .card{max-width:560px;margin:0 auto;border:1px solid #e6eef8;border-radius:12px;padding:1rem}
    .ok{color:#165a22}.err{color:#a0302a}
    .muted{color:#6b7b93;font-size:.95rem}
  </style>
</head>
<body>
  <main class="card">
    <h1>Signing you in…</h1>
    <p id="msg" class="muted">Please wait a moment while we complete your login.</p>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/dist/umd/supabase.js"></script>
  <script>
    (async function(){
      // ---- EDIT: use your project URL + ANON key
      const supa = supabase.createClient(
        'https://qfldkqowlqkokpqwqdpl.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmbGRrcW93bHFrb2twcXdxZHBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0ODIxNTMsImV4cCI6MjA3MzA1ODE1M30.TtzlGJIl0Vmn2nI2plqnNvq4NaVH1urNgch982glytg'
      );

      const message = document.getElementById('msg');

      // If Supabase sent an error in the hash, show it
      const rawHash = window.location.hash || '';
      const params = new URLSearchParams(rawHash.replace(/^#/, ''));
      if (params.get('error')) {
        message.textContent = decodeURIComponent(params.get('error_description') || 'Sign-in error');
        message.className = 'err';
        return;
      }

      // Supabase v2 parses the hash and sets the session when you call getSession/getUser
      const wait = ms => new Promise(r => setTimeout(r, ms));
      let tries = 0, user = null;

      // Give the SDK a few short attempts to finalize
      while (tries < 7) {
        try {
          const { data: { user: u } } = await supa.auth.getUser();
          if (u) { user = u; break; }
        } catch (e) { /* ignore and retry briefly */ }
        await wait(250);
        tries++;
      }

      if (!user) {
        message.textContent = 'Unable to finish sign-in. The link may have expired. Please request a new magic link.';
        message.className = 'err';
        return;
      }

      // Route by role (default to parent)
      const role = user.user_metadata?.role || 'parent';
      message.textContent = 'Signed in! Redirecting…';
      message.className = 'ok';

      if (role === 'admin')       window.location.replace('/admin.html');
      else if (role === 'groomer') window.location.replace('/dashboard.html'); // adjust if you have a groomer dashboard
      else                         window.location.replace('/dashboard.html');
    })();
  </script>
</body>
</html>