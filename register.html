<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fluryy — Register</title>
  <link rel="stylesheet" href="/css/styles.css?v=1.2.8"/>
  <style>
    .wrap{max-width:460px;margin:0 auto;padding:2rem 1rem}
    .card{background:#fff;border:1px solid #e6eef8;border-radius:12px;padding:1rem}
    .input{width:100%;padding:.6rem .7rem;border:1px solid #e0e6f3;border-radius:10px}
    .btn{border-radius:10px;border:1px solid #2F80ED;padding:.6rem .9rem;background:#2F80ED;color:#fff;cursor:pointer}
    .btn.btn-outline{background:#fff;color:#2F80ED}
    .help{color:#546274;font-size:.95rem;margin-top:.5rem}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Create your account</h1>
    <div class="card">
      <form id="register-form" novalidate>
        <label>Email
          <input type="email" class="input" name="email" autocomplete="email" required>
        </label>
        <label style="margin-top:.7rem">Role
          <select class="input" name="role" required>
            <option value="parent">Pet Parent</option>
            <option value="groomer">Groomer</option>
          </select>
        </label>
        <div style="margin-top:1rem;display:flex;gap:.6rem;align-items:center;flex-wrap:wrap">
          <button class="btn" type="submit">Send Magic Link</button>
          <a class="btn btn-outline" href="/login.html">Go to Login</a>
        </div>
        <div id="msg" class="help" role="status" aria-live="polite"></div>
      </form>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/dist/umd/supabase.js"></script>
<script>
  const supa = supabase.createClient(
    'https://qfldkqowlqkokpqwqdpl.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmbGRrcW93bHFrb2twcXdxZHBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0ODIxNTMsImV4cCI6MjA3MzA1ODE1M30.TtzlGJIl0Vmn2nI2plqnNvq4NaVH1urNgch982glytg'
  );

  const form = document.getElementById('register-form');
  const msg  = document.getElementById('msg');
  const btn  = form.querySelector('button[type="submit"]');
  const COOLDOWN_SEC = 60;

  function key(email){ return `mlCooldown:${email.toLowerCase()}`; }
  function now(){ return Math.floor(Date.now()/1000); }
  function remaining(email){ const until = Number(localStorage.getItem(key(email))||0); return Math.max(0, until - now()); }
  function startCooldown(email){ localStorage.setItem(key(email), String(now() + COOLDOWN_SEC)); tick(email); }

  let timer;
  function tick(email){
    clearInterval(timer);
    function update(){
      const r = remaining(email);
      if (r>0){ btn.disabled = true; btn.textContent = `Wait ${r}s`; }
      else { btn.disabled = false; btn.textContent = 'Send Magic Link'; clearInterval(timer); }
    }
    update(); timer = setInterval(update, 1000);
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '';
    const email = form.email.value.trim();
    const role  = form.role.value;
    if (!email || !role){ msg.textContent = 'Please fill in all fields.'; return; }

    if (remaining(email) > 0){
      tick(email);
      msg.textContent = 'You requested a link recently. Please try again after the countdown.';
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Sending…';

    const { error } = await supa.auth.signInWithOtp({
      email,
      options: {
        emailRedirectTo: 'https://fluryy.com/auth/callback.html',
        data: { role } // store intended role in user_metadata on first login
      }
    });

    if (error){
      if (/rate limit/i.test(error.message) || /429/.test(String(error.status||''))){
        startCooldown(email);
        msg.textContent = 'Too many requests. Please wait a minute before trying again.';
      } else {
        btn.disabled = false;
        btn.textContent = 'Send Magic Link';
        msg.textContent = 'Error: ' + error.message;
      }
    } else {
      startCooldown(email);
      msg.textContent = 'Magic link sent! Check your inbox.';
    }
  });
</script>

</body>
</html>
