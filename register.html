<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fluryy — Register</title>
  <link rel="stylesheet" href="/css/styles.css?v=1.2.9"/>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; padding: 2rem; }
    .card { max-width: 420px; margin: 0 auto; border: 1px solid #e6eef8; border-radius: 12px; padding: 1.5rem; }
    .input { width: 100%; padding: .5rem; margin-top: .25rem; }
    .btn { display: inline-block; margin-top: 1rem; padding: .6rem 1rem; background:#2F80ED; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    #msg { margin-top:.75rem; font-weight:600; }
  </style>
</head>
<body>
  <main class="card">
    <h1>Register for Fluryy</h1>
    <p>Sign up with your email and select a role.</p>
    <form id="register-form" novalidate>
      <label>Email
        <input class="input" type="email" name="email" required>
      </label><br>
      <label>Role
        <select class="input" name="role" required>
          <option value="">Select a role</option>
          <option value="parent">Pet Parent</option>
          <option value="groomer">Groomer</option>
        </select>
      </label>
      <!-- Honeypot -->
      <input type="text" name="company" style="display:none">
      <button class="btn" type="submit">Send Magic Link</button>
      <div id="msg"></div>
    </form>
    <p style="margin-top:1rem;">Already have an account? <a href="/login.html">Login</a></p>
  </main>

  <script>
    const form = document.getElementById('register-form');
    const msg  = document.getElementById('msg');
    const btn  = form.querySelector('button[type="submit"]');

    const COOLDOWN_SEC = 60;
    function key(email){ return `mlCooldown:${email.toLowerCase()}`; }
    function now(){ return Math.floor(Date.now()/1000); }
    function remaining(email){ const until = Number(localStorage.getItem(key(email))||0); return Math.max(0, until - now()); }
    function startCooldown(email){ localStorage.setItem(key(email), String(now()+COOLDOWN_SEC)); tick(email); }
    let timer;
    function tick(email){
      clearInterval(timer);
      function update(){
        const r = remaining(email);
        if (r>0){ btn.disabled = true; btn.textContent = `Wait ${r}s`; }
        else { btn.disabled = false; btn.textContent = 'Send Magic Link'; clearInterval(timer); }
      }
      update(); timer = setInterval(update, 1000);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';
      const email = form.email.value.trim();
      const role  = form.role.value;
      const company = form.company.value.trim();

      if (!email || !role){ msg.textContent = 'Please fill in all fields.'; return; }
      if (company){ msg.textContent = 'Bot detected.'; return; }

      if (remaining(email) > 0){ tick(email); msg.textContent='You requested a link recently. Try after the countdown.'; return; }

      btn.disabled = true; btn.textContent = 'Sending…';
      const res = await fetch('/api/send-magic-link.js', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ email, role })
      });

      const data = await res.json();
      if (!res.ok){
        if (res.status === 429){
          startCooldown(email);
          msg.textContent = data.error || 'Too many requests. Please wait a minute.';
        } else {
          btn.disabled = false; btn.textContent='Send Magic Link';
          msg.textContent = data.error || 'Error sending magic link.';
        }
      } else {
        startCooldown(email);
        msg.textContent = 'Magic link sent! Check your inbox.';
      }
    });
  </script>
</body>
</html>